import{s as U,d as x,a as ge,n as K}from"./arcadeUtils.66d2e6b2.js";import{E as Y,b as le,e as oe,D as we,q as fe,y as he,h as ce,a as Ee,s as Ie,c as Fe,S as Z,A as De,I as $e,g as be,v as C,m as Ne,w as H,C as S,d as X}from"./featureSetUtils.7eb76970.js";import{ii as D,ik as N,id as $,iT as T,ic as P,ih as b,iM as z,i5 as O,il as M,i6 as Ae,iq as xe,ir as Se,is as Te,ip as Le,ib as k,lZ as ve,jh as Q,gH as B,iI as _,lK as V}from"./index.a831a68c.js";import{g as Oe,E as ue}from"./SpatialFilter.4d880740.js";import{WhereClause as E}from"./WhereClause.bf01d283.js";import"./MD5.7323a015.js";import"./executeForIds.ffb3ce11.js";import"./geometryEngineAsync.e26b1e4e.js";function Re(i,r,d,m){if(m.length===1){if(b(m[0]))return K(i,m[0],-1);if(M(m[0]))return K(i,m[0].toArray(),-1)}return K(i,m,-1)}async function ee(i,r,d){const m=i.getVariables();if(m.length>0){const g=[];for(let n=0;n<m.length;n++){const a={name:m[n]};g.push(await r.evaluateIdentifier(d,a))}const e={};for(let n=0;n<m.length;n++)e[m[n]]=g[n];return i.parameters=e,i}return i}function c(i,r,d=null){for(const m in i)if(m.toLowerCase()===r.toLowerCase())return i[m];return d}function de(i){if(i===null)return null;const r={type:c(i,"type",""),name:c(i,"name","")};if(r.type==="range")r.range=c(i,"range",[]);else{r.codedValues=[];for(const d of c(i,"codedValues",[]))r.codedValues.push({name:c(d,"name",""),code:c(d,"code",null)})}return r}function te(i){if(i===null)return null;const r={},d=c(i,"wkt",null);d!==null&&(r.wkt=d);const m=c(i,"wkid",null);return m!==null&&(r.wkid=m),r}function me(i){if(i===null)return null;const r={hasZ:c(i,"hasz",!1),hasM:c(i,"hasm",!1)},d=c(i,"spatialreference",null);d&&(r.spatialReference=te(d));const m=c(i,"x",null);if(m!==null)return r.x=m,r.y=c(i,"y",null),r;const g=c(i,"rings",null);if(g!==null)return r.rings=g,r;const e=c(i,"paths",null);if(e!==null)return r.paths=e,r;const n=c(i,"points",null);if(n!==null)return r.points=n,r;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const o=c(i,a,null);o!==null&&(r[a]=o)}return r}function Ce(i,r){for(const d of r)if(d===i)return!0;return!1}function Me(i){return!!i.layerDefinition&&!!i.featureSet&&Ce(i.layerDefinition.geometryType,["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&i.layerDefinition.objectIdField!==null&&i.layerDefinition.objectIdField!==""&&b(i.layerDefinition.fields)!==!1&&b(i.featureSet.features)!==!1}function Je(i){i.mode==="async"&&(i.functions.getuser=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{D(e,1,2);let n=N(e[1],""),a=n===!0;if(n=n===!0||n===!1?"":$(n),e[0]instanceof U){let u=null;r.services&&r.services.portal&&(u=r.services.portal),u=Y(e[0],u);const l=await le(u,n,a);if(l){const t=JSON.parse(JSON.stringify(l));for(const s of["lastLogin","created","modified"])t[s]!==void 0&&t[s]!==null&&(t[s]=new Date(t[s]));return x.convertObjectToArcadeDictionary(t)}return null}let o=null;if(T(e[0])&&(o=e[0]),o){if(a=!1,n)return null;await o.load();const u=await o.getOwningSystemUrl();if(!u){if(!n){const s=await o.getIdentityUser();return s?x.convertObjectToArcadeDictionary({username:s}):null}return null}let l=null;r.services&&r.services.portal&&(l=r.services.portal),l=Y(new U(u),l);const t=await le(l,n,a);if(t){const s=JSON.parse(JSON.stringify(t));for(const f of["lastLogin","created","modified"])s[f]!==void 0&&s[f]!==null&&(s[f]=new Date(s[f]));return x.convertObjectToArcadeDictionary(s)}return null}throw new Error("Invalid Parameter")})},i.signatures.push({name:"getuser",min:"1",max:"2"}),i.functions.featuresetbyid=function(r,d){return i.standardFunctionAsync(r,d,(m,g,e)=>{if(D(e,2,4),e[0]instanceof oe){const n=$(e[1]);let a=N(e[2],null);const o=P(N(e[3],!0));if(a===null&&(a=["*"]),b(a)===!1)throw new Error("Invalid Parameter");return e[0].featureSetById(n,o,a)}throw new Error("Invalid Parameter")})},i.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),i.functions.getfeatureset=function(r,d){return i.standardFunctionAsync(r,d,(m,g,e)=>{if(D(e,1,2),z(e[0])){let n=N(e[1],"datasource");return n===null&&(n="datasource"),n=$(n).toLowerCase(),we(e[0].fullSchema(),n,r.lrucache,r.interceptor,r.spatialReference)}throw new Error("Invalid Parameter")})},i.signatures.push({name:"getfeatureset",min:"1",max:"2"}),i.functions.featuresetbyportalitem=function(r,d){return i.standardFunctionAsync(r,d,(m,g,e)=>{if(D(e,2,5),e[0]===null)throw new Error("Portal is required");if(e[0]instanceof U){const l=$(e[1]),t=$(e[2]);let s=N(e[3],null);const f=P(N(e[4],!0));if(s===null&&(s=["*"]),b(s)===!1)throw new Error("Invalid Parameter");let w=null;return r.services&&r.services.portal&&(w=r.services.portal),w=Y(e[0],w),fe(l,t,r.spatialReference,s,f,w,r.lrucache,r.interceptor)}if(O(e[0])===!1)throw new Error("Portal is required");const n=$(e[0]),a=$(e[1]);let o=N(e[2],null);const u=P(N(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new Error("Invalid Parameter");if(r.services&&r.services.portal)return fe(n,a,r.spatialReference,o,u,r.services.portal,r.lrucache,r.interceptor);throw new Error("Portal is required")})},i.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),i.functions.featuresetbyname=function(r,d){return i.standardFunctionAsync(r,d,(m,g,e)=>{if(D(e,2,4),e[0]instanceof oe){const n=$(e[1]);let a=N(e[2],null);const o=P(N(e[3],!0));if(a===null&&(a=["*"]),b(a)===!1)throw new Error("Invalid Parameter");return e[0].featureSetByName(n,o,a)}throw new Error("Invalid Parameter")})},i.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),i.functions.featureset=function(r,d){return i.standardFunction(r,d,(m,g,e)=>{D(e,1,1);let n=e[0];const a={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(O(n))n=JSON.parse(n),n.layerDefinition!==void 0?(a.layerDefinition=n.layerDefinition,a.featureSet=n.featureSet,n.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=n.layerDefinition.spatialReference)):(a.featureSet.features=n.features,a.featureSet.geometryType=n.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=n.objectIdFieldName,a.layerDefinition.typeIdField=n.typeIdFieldName,a.layerDefinition.globalIdField=n.globalIdFieldName,a.layerDefinition.fields=n.fields,n.spatialReference&&(a.layerDefinition.spatialReference=n.spatialReference));else{if(!(e[0]instanceof x))throw new Error("Invalid Parameter");{n=JSON.parse(e[0].castToText());const o=c(n,"layerdefinition");if(o!==null){a.layerDefinition.geometryType=c(o,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=c(o,"globalidfield",""),a.layerDefinition.objectIdField=c(o,"objectidfield",""),a.layerDefinition.typeIdField=c(o,"typeidfield","");const u=c(o,"spatialreference",null);u&&(a.layerDefinition.spatialReference=te(u));for(const t of c(o,"fields",[])){const s={name:c(t,"name",""),alias:c(t,"alias",""),type:c(t,"type",""),nullable:c(t,"nullable",!0),editable:c(t,"editable",!0),length:c(t,"length",null),domain:de(c(t,"domain"))};a.layerDefinition.fields.push(s)}const l=c(n,"featureset",null);if(l){const t={};for(const s of a.layerDefinition.fields)t[s.name.toLowerCase()]=s.name;for(const s of c(l,"features",[])){const f={},w=c(s,"attributes",{});for(const F in w)f[t[F.toLowerCase()]]=w[F];a.featureSet.features.push({attributes:f,geometry:me(c(s,"geometry",null))})}}}else{a.layerDefinition.geometryType=c(n,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=c(n,"objectidfieldname",""),a.layerDefinition.typeIdField=c(n,"typeidfieldname","");const u=c(n,"spatialreference",null);u&&(a.layerDefinition.spatialReference=te(u));for(const t of c(n,"fields",[])){const s={name:c(t,"name",""),alias:c(t,"alias",""),type:c(t,"type",""),nullable:c(t,"nullable",!0),editable:c(t,"editable",!0),length:c(t,"length",null),domain:de(c(t,"domain"))};a.layerDefinition.fields.push(s)}const l={};for(const t of a.layerDefinition.fields)l[t.name.toLowerCase()]=t.name;for(const t of c(n,"features",[])){const s={},f=c(t,"attributes",{});for(const w in f)s[l[w.toLowerCase()]]=f[w];a.featureSet.features.push({attributes:s,geometry:me(c(t,"geometry",null))})}}}}if(Me(a)===!1)throw new Error("Invalid Parameter");return he.create(a,r.spatialReference)})},i.signatures.push({name:"featureset",min:"1",max:"1"}),i.functions.filter=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(D(e,2,2),b(e[0])||M(e[0])){const n=[];let a=e[0];a instanceof Ae&&(a=a.toArray());let o=null;if(e[1]instanceof xe)o=i.arcadeCustomFunctionHandler(e[1]);else if(e[1]instanceof Se)o=(...u)=>e[1].fn(r,{preparsed:!0,arguments:u});else{if(!(e[1]instanceof Te))throw new Error("Invalid Parameter");o=(...u)=>{if(u.length!==e[1].paramCount)throw new Error("Invalid parameters");return e[1].fn(...u)}}for(const u of a){const l=o(u);Le(l)?await l===!0&&n.push(u):l===!0&&n.push(u)}return n}if(T(e[0])){const n=await e[0].load(),a=E.create(e[1],n.getFieldsIndex()),o=a.getVariables();if(o.length>0){const u=[];for(let t=0;t<o.length;t++){const s={name:o[t]};u.push(await i.evaluateIdentifier(r,s))}const l={};for(let t=0;t<o.length;t++)l[o[t]]=u[t];return a.parameters=l,new ce({parentfeatureset:e[0],whereclause:a})}return new ce({parentfeatureset:e[0],whereclause:a})}throw new Error("Filter cannot accept this parameter type")})},i.signatures.push({name:"filter",min:"2",max:"2"}),i.functions.orderby=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(D(e,2,2),T(e[0])){const n=new Ee(e[1]);return new Ie({parentfeatureset:e[0],orderbyclause:n})}throw new Error("Order cannot accept this parameter type")})},i.signatures.push({name:"orderby",min:"2",max:"2"}),i.functions.top=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(D(e,2,2),T(e[0]))return new Fe({parentfeatureset:e[0],topnum:e[1]});if(b(e[0]))return k(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,k(e[1]));if(M(e[0]))return k(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,k(e[1]));throw new Error("Top cannot accept this parameter type")})},i.signatures.push({name:"top",min:"2",max:"2"}),i.functions.first=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(D(e,1,1),T(e[0])){const n=await e[0].first(m.abortSignal);if(n!==null){const a=ge.createFromGraphicLikeObject(n.geometry,n.attributes,e[0]);return a._underlyingGraphic=n,a}return n}return b(e[0])?e[0].length===0?null:e[0][0]:M(e[0])?e[0].length()===0?null:e[0].get(0):null})},i.signatures.push({name:"first",min:"1",max:"1"}),i.functions.attachments=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{D(e,1,2);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof x){if(e[1].hasField("minsize")&&(n.minsize=k(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=P(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=k(e[1].field("maxsize"))),e[1].hasField("types")){const a=ve(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new Error("Invalid Parameter")}if(z(e[0])){let a=e[0]._layer;return a instanceof Q&&(a=Z(a,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),a===null?[]:T(a)===!1?[]:(await a.load(),a.queryAttachments(e[0].field(a.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new Error("Invalid Parameter")})},i.signatures.push({name:"attachments",min:"1",max:"2"}),i.functions.featuresetbyrelationshipname=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{D(e,2,4);const n=e[0],a=$(e[1]);let o=N(e[2],null);const u=P(N(e[3],!0));if(o===null&&(o=["*"]),b(o)===!1)throw new Error("Invalid Parameter");if(e[0]===null)return null;if(!z(e[0]))throw new Error("Invalid Parameter");let l=n._layer;if(l instanceof Q&&(l=Z(l,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),l===null||T(l)===!1)return null;l=await l.load();const t=l.relationshipMetaData().filter(h=>h.name===a);if(t.length===0)return null;if(t[0].relationshipTableId!==void 0&&t[0].relationshipTableId!==null&&t[0].relationshipTableId>-1)return De(l,t[0],n.field(l.objectIdField),l.spatialReference,o,u,r.lrucache,r.interceptor);let s=l.serviceUrl();if(!s)return null;s=s.charAt(s.length-1)==="/"?s+t[0].relatedTableId.toString():s+"/"+t[0].relatedTableId.toString();const f=await $e(s,l.spatialReference,o,u,r.lrucache,r.interceptor);await f.load();let w=f.relationshipMetaData();if(w=w.filter(h=>h.id===t[0].id),n.hasField(t[0].keyField)===!1||n.field(t[0].keyField)===null){const h=await l.getFeatureByObjectId(n.field(l.objectIdField),[t[0].keyField]);if(h){const I=E.create(w[0].keyField+"= @id",f.getFieldsIndex());return I.parameters={id:h.attributes[t[0].keyField]},f.filter(I)}return new Oe({parentfeatureset:f})}const F=E.create(w[0].keyField+"= @id",f.getFieldsIndex());return F.parameters={id:n.field(t[0].keyField)},f.filter(F)})},i.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),i.functions.featuresetbyassociation=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{D(e,2,3);const n=e[0],a=$(N(e[1],"")).toLowerCase(),o=O(e[2])?$(e[2]):null;if(e[0]===null)return null;if(!z(e[0]))throw new Error("Invalid Parameter");let u=n._layer;if(u instanceof Q&&(u=Z(u,r.spatialReference,["*"],!0,r.lrucache,r.interceptor)),u===null||T(u)===!1)return null;await u.load();const l=u.serviceUrl(),t=await be(l,r.spatialReference);let s=null,f=null,w=!1;if(o!==null&&o!==""&&o!==void 0){for(const y of t.terminals)y.terminalName===o&&(f=y.terminalId);f===null&&(w=!0)}const F=t.associations.getFieldsIndex(),h=F.get("TOGLOBALID").name,I=F.get("FROMGLOBALID").name,J=F.get("TOTERMINALID").name,W=F.get("FROMTERMINALID").name,G=F.get("FROMNETWORKSOURCEID").name,j=F.get("TONETWORKSOURCEID").name,R=F.get("ASSOCIATIONTYPE").name,pe=F.get("ISCONTENTVISIBLE").name,ye=F.get("OBJECTID").name;for(const y of u.fields)if(y.type==="global-id"){s=n.field(y.name);break}let L=null,ne=new C(new B({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",t.associations.getFieldsIndex())),re=new C(new B({name:"side",alias:"side",type:"string"}),E.create("''",t.associations.getFieldsIndex()));const A="globalid",ae="globalId",ie={};for(const y in t.lkp)ie[y]=t.lkp[y].sourceId;const v=new Ne(new B({name:"classname",alias:"classname",type:"string"}),null,ie);let p="";switch(a){case"midspan":{p=`((${h}='${s}') OR ( ${I}='${s}')) AND (${R} IN (5))`,v.codefield=E.create(`CASE WHEN (${h}='${s}') THEN ${G} ELSE ${j} END`,t.associations.getFieldsIndex());const y=V(S.findField(t.associations.fields,I));y.name=A,y.alias=A,L=new C(y,E.create(`CASE WHEN (${I}='${s}') THEN ${h} ELSE ${I} END`,t.associations.getFieldsIndex())),ne=t.unVersion>=4?new X(S.findField(t.associations.fields,F.get("PERCENTALONG").name)):new C(new B({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",t.associations.getFieldsIndex()));break}case"junctionedge":{p=`((${h}='${s}') OR ( ${I}='${s}')) AND (${R} IN (4,6))`,v.codefield=E.create(`CASE WHEN (${h}='${s}') THEN ${G} ELSE ${j} END`,t.associations.getFieldsIndex());const y=V(S.findField(t.associations.fields,I));y.name=A,y.alias=A,L=new C(y,E.create(`CASE WHEN (${I}='${s}') THEN ${h} ELSE ${I} END`,t.associations.getFieldsIndex())),re=new C(new B({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${R}=4) THEN 'from' ELSE 'to' END`,t.associations.getFieldsIndex()));break}case"connected":{let y=`${h}='@T'`,se=`${I}='@T'`;f!==null&&(y+=` AND ${J}=@A`,se+=` AND ${W}=@A`),p="(("+y+") OR ("+se+"))",p=_(p,"@T",s),y=_(y,"@T",s),f!==null&&(y=_(y,"@A",f.toString()),p=_(p,"@A",f.toString())),v.codefield=E.create("CASE WHEN "+y+` THEN ${G} ELSE ${j} END`,t.associations.getFieldsIndex());const q=V(S.findField(t.associations.fields,I));q.name=A,q.alias=A,L=new C(q,E.create("CASE WHEN "+y+` THEN ${I} ELSE ${h} END`,t.associations.getFieldsIndex()));break}case"container":p=`${h}='${s}' AND ${R} = 2`,f!==null&&(p+=` AND ${J} = `+f.toString()),v.codefield=G,p="( "+p+" )",L=new H(S.findField(t.associations.fields,I),A,A);case"content":p=`(${I}='${s}' AND ${R} = 2)`,f!==null&&(p+=` AND ${W} = `+f.toString()),v.codefield=j,p="( "+p+" )",L=new H(S.findField(t.associations.fields,h),A,A);break;case"structure":p=`(${h}='${s}' AND ${R} = 3)`,f!==null&&(p+=` AND ${J} = `+f.toString()),v.codefield=G,p="( "+p+" )",L=new H(S.findField(t.associations.fields,I),A,ae);break;case"attached":p=`(${I}='${s}' AND ${R} = 3)`,f!==null&&(p+=` AND ${W} = `+f.toString()),v.codefield=j,p="( "+p+" )",L=new H(S.findField(t.associations.fields,h),A,ae);break;default:throw new Error("Invalid Parameter")}return w&&(p="1 <> 1"),new S({parentfeatureset:t.associations,adaptedFields:[new X(S.findField(t.associations.fields,ye)),new X(S.findField(t.associations.fields,pe)),L,re,v,ne],extraFilter:p?E.create(p,t.associations.getFieldsIndex()):null})})},i.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),i.functions.groupby=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(D(e,3,3),!T(e[0]))throw new Error("Illegal Value: GroupBy");const n=await e[0].load(),a=[],o=[];let u=!1,l=[];if(O(e[1]))l.push(e[1]);else if(e[1]instanceof x)l.push(e[1]);else if(b(e[1]))l=e[1];else{if(!M(e[1]))throw new Error("Illegal Value: GroupBy");l=e[1].toArray()}for(const t of l)if(O(t)){const s=E.create($(t),n.getFieldsIndex()),f=ue(s)===!0?$(t):"%%%%FIELDNAME";a.push({name:f,expression:s}),f==="%%%%FIELDNAME"&&(u=!0)}else{if(!(t instanceof x))throw new Error("Illegal Value: GroupBy");{const s=t.hasField("name")?t.field("name"):"%%%%FIELDNAME",f=t.hasField("expression")?t.field("expression"):"";if(s==="%%%%FIELDNAME"&&(u=!0),!s)throw new Error("Illegal Value: GroupBy");a.push({name:s,expression:E.create(f||s,n.getFieldsIndex())})}}if(l=[],O(e[2]))l.push(e[2]);else if(b(e[2]))l=e[2];else if(M(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof x))throw new Error("Illegal Value: GroupBy");l.push(e[2])}for(const t of l){if(!(t instanceof x))throw new Error("Illegal Value: GroupBy");{const s=t.hasField("name")?t.field("name"):"",f=t.hasField("statistic")?t.field("statistic"):"",w=t.hasField("expression")?t.field("expression"):"";if(!s||!f||!w)throw new Error("Illegal Value: GroupBy");o.push({name:s,statistic:f.toLowerCase(),expression:E.create(w,n.getFieldsIndex())})}}if(u){const t={};for(const f of n.fields)t[f.name.toLowerCase()]=1;for(const f of a)f.name!=="%%%%FIELDNAME"&&(t[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(t[f.name.toLowerCase()]=1);let s=0;for(const f of a)if(f.name==="%%%%FIELDNAME"){for(;t["field_"+s.toString()]===1;)s++;t["field_"+s.toString()]=1,f.name="FIELD_"+s.toString()}}for(const t of a)await ee(t.expression,i,r);for(const t of o)await ee(t.expression,i,r);return e[0].groupby(a,o)})},i.signatures.push({name:"groupby",min:"3",max:"3"}),i.functions.distinct=function(r,d){return i.standardFunctionAsync(r,d,async(m,g,e)=>{if(T(e[0])){D(e,2,2);const n=await e[0].load(),a=[];let o=[];if(O(e[1]))o.push(e[1]);else if(e[1]instanceof x)o.push(e[1]);else if(b(e[1]))o=e[1];else{if(!M(e[1]))throw new Error("Illegal Value: GroupBy");o=e[1].toArray()}let u=!1;for(const l of o)if(O(l)){const t=E.create($(l),n.getFieldsIndex()),s=ue(t)===!0?$(l):"%%%%FIELDNAME";a.push({name:s,expression:t}),s==="%%%%FIELDNAME"&&(u=!0)}else{if(!(l instanceof x))throw new Error("Illegal Value: GroupBy");{const t=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",s=l.hasField("expression")?l.field("expression"):"";if(t==="%%%%FIELDNAME"&&(u=!0),!t)throw new Error("Illegal Value: GroupBy");a.push({name:t,expression:E.create(s||t,n.getFieldsIndex())})}}if(u){const l={};for(const s of n.fields)l[s.name.toLowerCase()]=1;for(const s of a)s.name!=="%%%%FIELDNAME"&&(l[s.name.toLowerCase()]=1);let t=0;for(const s of a)if(s.name==="%%%%FIELDNAME"){for(;l["field_"+t.toString()]===1;)t++;l["field_"+t.toString()]=1,s.name="FIELD_"+t.toString()}}for(const l of a)await ee(l.expression,i,r);return e[0].groupby(a,[])}return Re("distinct",m,g,e)})})}export{Je as registerFunctions};
