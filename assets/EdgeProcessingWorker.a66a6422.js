import{n as St}from"./deduplicate.f083e52b.js";import{T as U}from"./InterleavedLayout.dbee1542.js";import{y as Tt,u as yt,i as Dt,c as Lt,l as vt,p as Vt,o as Pt,m as xt,T as bt,h as Mt,a as Ut,b as Ft,d as Rt,A as Bt,O as Ct,x as Ht,g as Gt,w as Wt,E as kt,L as zt,B as Kt,F as Xt,I as _t,U as qt,j as Jt,V as jt,M as Yt,S as Qt,k as Zt,q as te,v as ee,z as ne,C as se,D as oe,G as re,H as ie}from"./BufferView.cd94a44a.js";import{b7 as ae,fA as ce,fB as mt,B as S,dN as it,fC as le,fD as fe,D as k,fE as at,fF as X,fG as ue,fH as ge,fI as ht,fJ as ct,fK as de}from"./index.a831a68c.js";import{O as u}from"./VertexAttribute.c697ed2b.js";import{C as v}from"./enums.c60b1dad.js";import{t as pe}from"./VertexElementDescriptor.2400a91d.js";import"./types.5f4a0b28.js";function lt(t,e,n){const o=e/3,r=new Uint32Array(n+1),i=new Uint32Array(n+1),p=(s,a)=>{s<a?r[s+1]++:i[a+1]++};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];p(a,g),p(g,d),p(d,a)}let c=0,m=0;for(let s=0;s<n;s++){const a=r[s+1],g=i[s+1];r[s+1]=c,i[s+1]=m,c+=a,m+=g}const l=new Uint32Array(6*o),f=r[n],I=(s,a,g)=>{if(s<a){const d=r[s+1]++;l[2*d]=a,l[2*d+1]=g}else{const d=i[a+1]++;l[2*f+2*d]=s,l[2*f+2*d+1]=g}};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];I(a,g,s),I(g,d,s),I(d,a,s)}const N=(s,a)=>{const g=2*s,d=a-s;for(let A=1;A<d;A++){const O=l[g+2*A],D=l[g+2*A+1];let w=A-1;for(;w>=0&&l[g+2*w]>O;w--)l[g+2*w+2]=l[g+2*w],l[g+2*w+3]=l[g+2*w+1];l[g+2*w+2]=O,l[g+2*w+3]=D}};for(let s=0;s<n;s++)N(r[s],r[s+1]),N(f+i[s],f+i[s+1]);const h=new Int32Array(3*o),T=(s,a)=>s===t[3*a]?0:s===t[3*a+1]?1:s===t[3*a+2]?2:-1,$=(s,a)=>{const g=T(s,a);h[3*a+g]=-1},y=(s,a,g,d)=>{const A=T(s,a);h[3*a+A]=d;const O=T(g,d);h[3*d+O]=a};for(let s=0;s<n;s++){let a=r[s];const g=r[s+1];let d=i[s];const A=i[s+1];for(;a<g&&d<A;){const O=l[2*a],D=l[2*f+2*d];O===D?(y(s,l[2*a+1],D,l[2*f+2*d+1]),a++,d++):O<D?($(s,l[2*a+1]),a++):($(D,l[2*f+2*d+1]),d++)}for(;a<g;)$(s,l[2*a+1]),a++;for(;d<A;)$(l[2*f+2*d],l[2*f+2*d+1]),d++}return h}function H(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:me(t.layout)}}function me(t){const e=new Array;return t.fields.forEach((n,o)=>{const r={...n,constructor:It(n.constructor)};e.push([o,r])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const he=[Tt,yt,Dt,Lt,vt,Vt,Pt,xt,bt,Mt,Ut,Ft,Rt,Bt,Ct,Ht,Gt,Wt,kt,zt,Kt,Xt,_t,qt,Jt,jt,Yt,Qt,Zt,te,ee,ne,se,oe,re,ie];function It(t){return`${t.ElementType}_${t.ElementCount}`}const Ie=new Map;he.forEach(t=>Ie.set(It(t),t));function tt(t,e=0){const n=t.stride;return t.fieldNames.filter(o=>{const r=t.fields.get(o).optional;return!(r&&r.glPadding)}).map(o=>{const r=t.fields.get(o),i=r.constructor.ElementCount,p=Ne(r.constructor.ElementType),c=r.offset,m=!(!r.optional||!r.optional.glNormalized);return new pe(o,i,p,c,n,m,e)})}function Ne(t){const e=$e[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const $e={u8:v.UNSIGNED_BYTE,u16:v.UNSIGNED_SHORT,u32:v.UNSIGNED_INT,i8:v.BYTE,i16:v.SHORT,i32:v.INT,f32:v.FLOAT},Nt=U().vec3f(u.POSITION).u16(u.COMPONENTINDEX).u16(u.U16PADDING),Ae=U().vec2u8(u.SIDENESS);tt(Ae);const $t=U().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u8(u.VARIANTOFFSET,{glNormalized:!0}).u8(u.VARIANTSTROKE).u8(u.VARIANTEXTENSION,{glNormalized:!0}).u8(u.U8PADDING,{glPadding:!0}).u16(u.U16PADDING,{glPadding:!0}),_=$t.clone().vec3f(u.NORMAL),q=$t.clone().vec3f(u.NORMALA).vec3f(u.NORMALB);u.POSITION0,u.POSITION1,u.COMPONENTINDEX,u.VARIANTOFFSET,u.VARIANTSTROKE,u.VARIANTEXTENSION,u.NORMAL,u.NORMALA,u.NORMALB,u.SIDENESS;class At{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Ee:we}write(e,n,o){const r=this.edgeHashFunction(o);C.seed=r;const i=C.getIntRange(0,255),p=C.getIntRange(0,this.settings.variants-1),c=.7,m=C.getFloat(),l=255*(.5*Oe(-(1-Math.min(m/c,1))+Math.max(0,m-c)/(1-c),1.2)+.5);e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex),e.variantOffset.set(n,i),e.variantStroke.set(n,p),e.variantExtension.set(n,l)}trim(e,n){return e.slice(0,n)}}const et=new Float32Array(6),G=new Uint32Array(et.buffer),L=new Uint32Array(1);function we(t){const e=et;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],L[0]=5381;for(let n=0;n<G.length;n++)L[0]=31*L[0]+G[n];return L[0]}function Ee(t){const e=et;e[0]=b(t.position0[0]),e[1]=b(t.position0[1]),e[2]=b(t.position0[2]),e[3]=b(t.position1[0]),e[4]=b(t.position1[1]),e[5]=b(t.position1[2]),L[0]=5381;for(let n=0;n<G.length;n++)L[0]=31*L[0]+G[n];return L[0]}const ft=1e4;function b(t){return Math.round(t*ft)/ft}function Oe(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class J{constructor(){this.commonWriter=new At}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return _.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),ce(B,o.faceNormal0,o.faceNormal1),mt(B,B),e.normal.setVec(n,B)}trim(e,n){return this.commonWriter.trim(e,n)}}J.Layout=_,J.glLayout=tt(_,1);class j{constructor(){this.commonWriter=new At}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return q.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),e.normalA.setVec(n,o.faceNormal0),e.normalB.setVec(n,o.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}j.Layout=q,j.glLayout=tt(q,1);const B=S(),C=new ae,V=-1;var ut;function Y(t,e,n,o=ve){const r=t.vertices.position,i=t.vertices.componentIndex,p=it(o.anglePlanar),c=it(o.angleSignificantEdge),m=Math.cos(c),l=Math.cos(p),f=Q.edge,I=f.position0,N=f.position1,h=f.faceNormal0,T=f.faceNormal1,$=Le(t),y=De(t),s=y.length/4,a=e.allocate(s);let g=0;const d=s,A=n.allocate(d);let O=0,D=0,w=0;const nt=le(0,s),F=new Float32Array(s);fe(F,(P,E,M)=>{r.getVec(y[4*E+0],I),r.getVec(y[4*E+1],N),M[E]=de(I,N)}),nt.sort((P,E)=>F[E]-F[P]);const st=new Array,ot=new Array;for(let P=0;P<s;P++){const E=nt[P],M=F[E],W=y[4*E+0],Ot=y[4*E+1],x=y[4*E+2],R=y[4*E+3],rt=R===V;if(r.getVec(W,I),r.getVec(Ot,N),rt)k(h,$[3*x+0],$[3*x+1],$[3*x+2]),at(T,h),f.componentIndex=i.get(W),f.cosAngle=X(h,T);else{if(k(h,$[3*x+0],$[3*x+1],$[3*x+2]),k(T,$[3*R+0],$[3*R+1],$[3*R+2]),f.componentIndex=i.get(W),f.cosAngle=X(h,T),Te(f,l))continue;f.cosAngle<-.9999&&at(T,h)}D+=M,w++,rt||Se(f,m)?(e.write(a,g++,f),st.push(M)):ye(f,p)&&(n.write(A,O++,f),ot.push(M))}const wt=new Float32Array(st.reverse()),Et=new Float32Array(ot.reverse());return{regular:{instancesData:e.trim(a,g),lodInfo:{lengths:wt}},silhouette:{instancesData:n.trim(A,O),lodInfo:{lengths:Et}},averageEdgeLength:D/w}}function Se(t,e){return t.cosAngle<e}function Te(t,e){return t.cosAngle>e}function ye(t,e){const n=ue(t.cosAngle),o=Q.fwd,r=Q.ortho;return ge(o,t.position1,t.position0),n*(X(ht(r,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}function De(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let r=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],f=o[3*c+2],I=n[3*c+0],N=n[3*c+1],h=n[3*c+2];r+=m===V||I<N?1:0,r+=l===V||N<h?1:0,r+=f===V||h<I?1:0}const i=new Int32Array(4*r);let p=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],f=o[3*c+2],I=n[3*c+0],N=n[3*c+1],h=n[3*c+2];(m===V||I<N)&&(i[p++]=I,i[p++]=N,i[p++]=c,i[p++]=m),(l===V||N<h)&&(i[p++]=N,i[p++]=h,i[p++]=c,i[p++]=l),(f===V||h<I)&&(i[p++]=h,i[p++]=I,i[p++]=c,i[p++]=f)}return i}function Le(t){const e=t.faces.length/3,n=t.vertices.position,o=t.faces,r=z.v0,i=z.v1,p=z.v2,c=new Float32Array(3*e);for(let m=0;m<e;m++){const l=o[3*m+0],f=o[3*m+1],I=o[3*m+2];n.getVec(l,r),n.getVec(f,i),n.getVec(I,p),ct(i,i,r),ct(p,p,r),ht(r,i,p),mt(r,r),c[3*m+0]=r[0],c[3*m+1]=r[1],c[3*m+2]=r[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ut||(ut={}));const Q={edge:{position0:S(),position1:S(),faceNormal0:S(),faceNormal1:S(),componentIndex:0,cosAngle:0},ortho:S(),fwd:S()},z={v0:S(),v1:S(),v2:S()},ve={anglePlanar:4,angleSignificantEdge:35};class Ve{async extract(e){const n=K(e),o=Pe(n),r=[n.data.buffer];return{result:xe(o,r),transferList:r}}async extractComponentsEdgeLocations(e){const n=K(e),o=Z(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=Y(o,Fe,pt),i=[];return{result:H(r.regular.instancesData,i),transferList:i}}async extractEdgeLocations(e){const n=K(e),o=Z(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=Y(o,Ue,pt),i=[];return{result:H(r.regular.instancesData,i),transferList:i}}}function Pe(t){const e=Z(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return gt.updateSettings(t.writerSettings),dt.updateSettings(t.writerSettings),Y(e,gt,dt)}function K(t){return{data:Nt.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function xe(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:H(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:H(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Z(t,e,n,o){if(e)return{faces:n,facesLength:o,neighbors:lt(n,o,t.count),vertices:t};const r=St(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:o}),i=lt(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:Nt.createView(r.buffer)}}const gt=new J,dt=new j;class be{allocate(e){return Re.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1)}}class Me{allocate(e){return Be.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex)}}const Ue=new be,Fe=new Me,pt={allocate:()=>null,write:()=>{},trim:()=>null},Re=U().vec3f(u.POSITION0).vec3f(u.POSITION1),Be=U().vec3f(u.POSITION0).vec3f(u.POSITION1).u16(u.COMPONENTINDEX).u16(u.U16PADDING,{glPadding:!0});function _e(){return new Ve}export{Ve as EdgeProcessingWorker,_e as default,Pe as extract,Be as extractComponentsEdgeLocationsLayout,Re as extractEdgeLocationsLayout};
